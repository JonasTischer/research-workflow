#!/bin/bash
# Pre-commit hook for citation verification
# Install: cp hooks/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running citation checks...${NC}"

# Find thesis directory (adjust path as needed)
THESIS_DIR="${THESIS_DIR:-./chapters}"
BIB_FILE="${BIB_FILE:-./references.bib}"
MARKDOWN_DIR="${MARKDOWN_DIR:-./markdown}"

# Check if we have .tex files staged
STAGED_TEX=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tex$' || true)

if [ -z "$STAGED_TEX" ]; then
    echo -e "${GREEN}No .tex files staged, skipping citation check${NC}"
    exit 0
fi

# Quick check: verify all citation keys exist in .bib
echo "Checking citation keys..."

MISSING_KEYS=""
for tex_file in $STAGED_TEX; do
    # Extract citation keys
    KEYS=$(grep -oP '\\cite[pt]?\{\K[^}]+' "$tex_file" 2>/dev/null | tr ',' '\n' | sed 's/^ *//' | sort -u || true)
    
    for key in $KEYS; do
        if [ -n "$key" ] && ! grep -q "@.*{${key}," "$BIB_FILE" 2>/dev/null; then
            MISSING_KEYS="$MISSING_KEYS\n  - $key (in $tex_file)"
        fi
    done
done

if [ -n "$MISSING_KEYS" ]; then
    echo -e "${RED}ERROR: Missing citation keys in .bib:${NC}"
    echo -e "$MISSING_KEYS"
    echo ""
    echo "Add these entries to $BIB_FILE before committing."
    exit 1
fi

echo -e "${GREEN}âœ“ All citation keys found in .bib${NC}"

# Optional: Run full verification (slower, checks claims against papers)
if [ "$VERIFY_CLAIMS" = "1" ]; then
    echo "Running claim verification (this may take a minute)..."
    python src/citation_checker.py "$THESIS_DIR" "$BIB_FILE" --markdown-dir "$MARKDOWN_DIR"
fi

exit 0
